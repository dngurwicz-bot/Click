import { createClient } from '@/lib/supabase/client'

// Interfaces
export interface Organization {
  id: string
  internal_id?: string
  name: string
  hp?: string
  contact_name?: string
  contact_email?: string
  is_active: boolean
  modules?: string[]
  is_master?: boolean
  sync_with_master?: boolean
  created_at: string
  updated_at: string
}

export interface OrgUser {
  id: string
  email: string
  name: string
  role: 'admin' | 'manager' | 'employee'
  org_id: string
}

class ApiClient {
  private supabase = createClient()

  // Organizations
  async getOrganizations() {
    const { data, error } = await this.supabase
      .from('organizations')
      .select('*')
      .order('created_at', { ascending: false })

    if (error) throw error
    return data as Organization[]
  }

  async createOrganization(org: { name: string; hp?: string; contact_name?: string; contact_email?: string; is_active: boolean; modules?: string[] }) {
    // Note: internal_id is generated by the database if the column exists and has a default/sequence
    const { data, error } = await this.supabase
      .from('organizations')
      .insert([org])
      .select()
      .single()

    if (error) throw error
    return data as Organization
  }

  async updateOrganization(id: string, updates: Partial<Organization>) {
    const { data, error } = await this.supabase
      .from('organizations')
      .update(updates)
      .eq('id', id)
      .select()
      .single()

    if (error) throw error
    return data as Organization
  }

  async deleteOrganization(id: string) {
    const { error } = await this.supabase
      .from('organizations')
      .delete()
      .eq('id', id)

    if (error) throw error
    return true
  }

  // Organization Users
  async getOrgUsers(orgId: string) {
    // Note: This requires a 'users' or 'organization_users' table which might not exist yet in the real DB.
    // For this simple implementation, we'll try to insert into a 'users' table or return empty if not found.
    // Typically users are handled via Supabase Auth and a public profiles table.

    const { data, error } = await this.supabase
      .from('users') // Assuming a users table in public schema
      .select('*')
      .eq('org_id', orgId)

    if (error) {
      console.warn('Error fetching users (table might not exist):', error)
      return []
    }
    return data as OrgUser[]
  }

  async createOrgUser(orgId: string, userData: { name: string; email: string; role: string }) {
    // In a real app this should create a Supabase Auth user + public profile
    // Here we just insert into 'users' table for simplicity as per requirement
    const { data, error } = await this.supabase
      .from('users')
      .insert([{ ...userData, org_id: orgId }])
      .select()
      .single()

    if (error) throw error
    return data as OrgUser
  }

  // Updates
  async getUpdates(orgId?: string) {
    let query = this.supabase
      .from('updates')
      .select('*')
      .order('created_at', { ascending: false })

    // If orgId is provided, filter by it. 
    // Otherwise RLS will handle it (User sees own, Admin sees all - but usually Admin wants to filter)
    if (orgId) {
      query = query.eq('org_id', orgId)
    }

    const { data, error } = await query

    if (error) {
      // If table doesn't exist yet, return empty to avoid crash during dev
      console.warn('Error fetching updates:', error)
      return []
    }
    return data
  }

  async createUpdate(update: { org_id: string; title: string; content: string; link?: string; link_text?: string }) {
    const { data, error } = await this.supabase
      .from('updates')
      .insert([update])
      .select()
      .single()

    if (error) throw error
    return data
  }

  async deleteUpdate(id: string) {
    const { error } = await this.supabase
      .from('updates')
      .delete()
      .eq('id', id)

    if (error) throw error
    return true
  }

  async updateUpdate(id: string, update: { title?: string; content?: string; link?: string; link_text?: string }) {
    const { data, error } = await this.supabase
      .from('updates')
      .update(update)
      .eq('id', id)
      .select()
      .single()

    if (error) throw error
    return data
  }
}

export const api = new ApiClient()
